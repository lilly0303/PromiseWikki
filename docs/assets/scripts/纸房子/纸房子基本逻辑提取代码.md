# çº¸æˆ¿å­ UnityExplorer å‰§æœ¬é€è§†è„šæœ¬

> **å·¥å…·ç‰ˆæœ¬**ï¼šUnityExplorer 4.9 (REPL Console)  
> **æ¸¸æˆå¼•æ“**ï¼šUnity 2022 + Naninovel  
> **åŠŸèƒ½**ï¼šé€šè¿‡ C# åå°„æœºåˆ¶ï¼Œå¼ºåˆ¶é€è§†å†…å­˜ä¸­ Naninovel å‰§æœ¬çš„åº•å±‚æŒ‡ä»¤ã€å˜é‡æ“ä½œå’Œé€»è¾‘è·³è½¬ã€‚

## è„šæœ¬ä»£ç 

æ­¤è„šæœ¬å¯ç›´æ¥åœ¨ UnityExplorer çš„ **Console (C# Script)** é€‰é¡¹å¡ä¸­è¿è¡Œã€‚

## tips

### ç»™ä½ çš„ç½‘é¡µè¡¥å……è¯´æ˜ï¼ˆå»ºè®®åŠ ä¸Šï¼‰

> **ğŸ’¡ æå–ç»“æœåˆ†æ**ï¼š
> åœ¨ç”Ÿæˆçš„æŠ¥å‘Šä¸­ï¼Œä½ å¯èƒ½ä¼šçœ‹åˆ°ç±»ä¼¼äº `[å‰§æƒ…] wyhï¼šNewscript #36.1 |#~3fb402f3|` çš„å†…å®¹ã€‚
> * **ä»£ç å«ä¹‰**ï¼šè¿™è¯´æ˜æ¸¸æˆå¯ç”¨äº† Managed Textï¼ˆæ‰˜ç®¡æ–‡æœ¬ï¼‰æ¨¡å¼ã€‚è„šæœ¬æ–‡ä»¶ä¸­åªå­˜å‚¨äº†æ–‡æœ¬çš„ç´¢å¼• IDï¼ˆHash Keyï¼‰ï¼Œè€Œæ²¡æœ‰ç›´æ¥å­˜å‚¨ä¸­æ–‡æ–‡æœ¬ã€‚
> * **å˜é‡é€»è¾‘**ï¼šä½†æ‰€æœ‰çš„**å˜é‡æ“ä½œ**ï¼ˆå¦‚ `Expression=[ç‹è‰ºè¡=0]`ï¼‰å’Œ**åˆ†æ”¯æ¡ä»¶**éƒ½æ˜¯å®Œæ•´çš„ã€‚è¿™å¯¹äºåˆ†ææ¸¸æˆçš„æ•°å€¼åˆ¤å®šå’Œç»“å±€åˆ†æ­§ç‚¹å·²ç»è¶³å¤Ÿäº†ã€‚

```csharp
// --- [1] åˆå§‹åŒ–è¾“å‡ºæ„å»ºå™¨ ---
// ç”¨äºå°†æ‰€æœ‰æå–åˆ°çš„ä¿¡æ¯æš‚æ—¶å­˜åœ¨å†…å­˜é‡Œï¼Œæœ€åä¸€æ¬¡æ€§å¯¼å‡º
var sb = new System.Text.StringBuilder();
sb.AppendLine("ã€Šçº¸æˆ¿å­ã€‹å…¨å­—æ®µæ— å·®åˆ«é€è§†ç‰ˆ - " + System.DateTime.Now.ToString());
sb.AppendLine("--------------------------------------------------");

// --- [2] è®¾å®šç›®æ ‡èŒƒå›´ ---
// åœ¨è¿™é‡Œå®šä¹‰ä½ æƒ³æå–çš„å‰§æœ¬æ–‡ä»¶å
var targetNames = new System.Collections.Generic.HashSet<string>() { "Script1", "Newscript", "Newscript1" };
var foundScripts = new System.Collections.Generic.List<Naninovel.Script>();

// --- [3] é”å®šå‰§æœ¬ (åŒé‡ä¿é™©) ---
// ç¬¬ä¸€æ­¥ï¼šæŸ¥æ‰¾å½“å‰å†…å­˜ä¸­å·²ç»åŠ è½½çš„å‰§æœ¬å¯¹è±¡
var scripts = UnityEngine.Resources.FindObjectsOfTypeAll<Naninovel.Script>();
foreach (var s in scripts) if (targetNames.Contains(s.name)) foundScripts.Add(s);

// ç¬¬äºŒæ­¥ï¼šå¦‚æœå†…å­˜é‡Œæ²¡æ‰¾åˆ°ï¼Œå°è¯•å¼ºåˆ¶ä»æ¸¸æˆèµ„æºåŒ…(Resources)é‡ŒåŠ è½½
if (foundScripts.Count == 0) {
    var loaded = UnityEngine.Resources.LoadAll<Naninovel.Script>("");
    foreach (var s in loaded) if (targetNames.Contains(s.name)) foundScripts.Add(s);
}

// --- [4] å®šä¹‰æ ¸å¿ƒå·¥å…·ï¼šåå°„é€è§† (Reflection) ---
// è¿™æ˜¯ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œç”¨äºæå– Naninovel ç‰¹æœ‰çš„ "Nullable" å‚æ•°ç±»å‹çš„å€¼
System.Func<object, string> GetVal = (obj) => {
    if (obj == null) return null;
    try {
        var t = obj.GetType();
        // ç¡®ä¿åªå¤„ç† Naninovel ç±»å‹çš„å‚æ•°
        if (!t.Namespace.StartsWith("Naninovel")) return null;
        
        // æ£€æŸ¥è¯¥å‚æ•°æ˜¯å¦æœ‰å€¼ (HasValue)
        var hv = t.GetProperty("HasValue");
        if (hv != null && !(bool)hv.GetValue(obj)) return null;
        
        // è·å–å®é™…çš„å€¼
        return t.GetProperty("Value")?.GetValue(obj)?.ToString();
    } catch { return null; }
};

// â˜…â˜…â˜… æš´åŠ›æœèº«å‡½æ•° â˜…â˜…â˜…
// æ— è®ºå­—æ®µæ˜¯å…¬å¼€çš„(Public)è¿˜æ˜¯ç§æœ‰çš„(Private)ï¼Œå¼ºåˆ¶è¯»å–æ‰€æœ‰å‚æ•°
System.Func<object, string> InspectAllFields = (cmdObj) =>
{
    if (cmdObj == null) return "";
    var info = new System.Collections.Generic.List<string>();
    
    try {
        // è·å–æ‰€æœ‰å­—æ®µä¿¡æ¯
        var fields = cmdObj.GetType().GetFields(System.Reflection.BindingFlags.Public | System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
        foreach (var f in fields)
        {
            // è¿‡æ»¤æ‰è¡Œå·ç­‰æ— ç”¨çš„å…ƒæ•°æ®ï¼Œåªçœ‹æ ¸å¿ƒé€»è¾‘
            if (f.Name == "LineNumber" || f.Name == "Indent" || f.Name == "PlaybackSpot") continue;
            
            var valObj = f.GetValue(cmdObj);
            var strVal = GetVal(valObj); // å°è¯•è§£æå€¼

            // å¦‚æœæ‰¾åˆ°äº†æœ‰æ•ˆå€¼ï¼Œå°±è®°å½•ä¸‹æ¥ï¼š[å‚æ•°å=å‚æ•°å€¼]
            if (!string.IsNullOrEmpty(strVal))
            {
                info.Add($"{f.Name}=[{strVal}]");
            }
        }
    } catch {}

    if (info.Count > 0) return " (" + string.Join(", ", info.ToArray()) + ")";
    return "";
};

// --- [5] å¼€å§‹éå†å¹¶æå– ---
foreach (var script in foundScripts)
{
    sb.AppendLine();
    sb.AppendLine($"ğŸ“„ å‰§æœ¬: {script.name}");
    sb.AppendLine("--------------------------------------------------");
    int lineIndex = 0;
    
    // é€è¡Œåˆ†æå‰§æœ¬
    foreach (var line in script.Lines)
    {
        lineIndex++;
        if (line == null) continue;
        string lType = line.GetType().Name;

        // === ç±»å‹A: å‰§æƒ…æ–‡æœ¬è¡Œ ===
        if (lType == "GenericTextScriptLine")
        {
            try {
                // æ·±å…¥æŒ–æ˜ç§æœ‰çš„ inlinedCommands å­—æ®µ
                var listField = line.GetType().GetField("inlinedCommands", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
                var list = listField?.GetValue(line) as System.Collections.IList;
                if (list != null && list.Count > 0)
                {
                    var sbLine = new System.Text.StringBuilder();
                    foreach (var cmd in list)
                    {
                        var textProp = cmd.GetType().GetField("Text");
                        var authProp = cmd.GetType().GetField("AuthorId");
                        var text = GetVal(textProp?.GetValue(cmd));
                        var auth = GetVal(authProp?.GetValue(cmd));
                        
                        // æ‹¼æ¥ï¼š[è§’è‰²å]ï¼š[å°è¯]
                        if (!string.IsNullOrEmpty(auth)) sbLine.Append(auth + "ï¼š");
                        if (!string.IsNullOrEmpty(text)) sbLine.Append(text);
                    }
                    if (sbLine.Length > 0) sb.AppendLine($"   [{lineIndex}] [å‰§æƒ…] " + sbLine.ToString());
                }
            } catch {}
        }
        // === ç±»å‹B: é€»è¾‘æŒ‡ä»¤è¡Œ ===
        else if (lType == "CommandScriptLine")
        {
            var cmdProp = line.GetType().GetProperty("Command");
            if (cmdProp != null)
            {
                var cmdObj = cmdProp.GetValue(line);
                if (cmdObj != null)
                {
                    string cName = cmdObj.GetType().Name;
                    // ç›´æ¥è°ƒç”¨ä¸Šé¢çš„â€œæš´åŠ›æœèº«â€å‡½æ•°ï¼Œè·å–è¯¥æŒ‡ä»¤çš„æ‰€æœ‰å‚æ•°
                    string allParams = InspectAllFields(cmdObj);

                    // æ ¹æ®æŒ‡ä»¤ç±»å‹ï¼Œæ‰“ä¸Šä¸åŒçš„æ ‡è®°ï¼Œæ–¹ä¾¿é˜…è¯»
                    if (cName.Contains("Choice"))
                    {
                        sb.AppendLine($"   [{lineIndex}] ğŸ”˜ [é€‰é¡¹] {allParams}");
                    }
                    else if (cName == "Set" || cName == "SetCustomVariable")
                    {
                        sb.AppendLine($"   [{lineIndex}] ğŸ”§ [å˜é‡] {allParams}");
                    }
                    else if (cName == "Goto")
                    {
                        sb.AppendLine($"   [{lineIndex}] ğŸ”€ [è·³è½¬] {allParams}");
                    }
                    else if (cName == "Stop")
                    {
                        sb.AppendLine($"   [{lineIndex}] ğŸ›‘ [åœæ­¢] {allParams}");
                    }
                    else if (cName == "Else" || cName == "ElseIf")
                    {
                        sb.AppendLine($"   [{lineIndex}] ğŸ”¹ [åˆ†æ”¯åˆ¤å®š] {cName} {allParams}");
                    }
                    else if (cName == "If" || cName == "BeginIf" || cName == "EndIf")
                    {
                        sb.AppendLine($"   [{lineIndex}] ğŸ”¹ [é€»è¾‘å—] {cName} {allParams}");
                    }
                    // å…¶ä»–æ‚é¡¹æŒ‡ä»¤ï¼Œä»…å½“åŒ…å«æ¡ä»¶åˆ¤æ–­(ConditionalExpression)æ—¶æ‰æ˜¾ç¤º
                    else if (!string.IsNullOrEmpty(allParams) && allParams.Contains("ConditionalExpression"))
                    {
                        sb.AppendLine($"   [{lineIndex}] âš™ï¸ [{cName}] {allParams}");
                    }
                }
            }
        }
    }
}

// --- [6] å¯¼å‡ºåˆ°æ¡Œé¢ ---
var finalContent = sb.ToString();

// ç®€å•çš„æ–‡æœ¬æ›¿æ¢ (å°†ä»£ç ä»£å·æ›¿æ¢ä¸ºä¸­æ–‡å)
finalContent = finalContent.Replace("WYH", "ç‹è‰ºè¡").Replace("LT", "é™†å©·").Replace("XMM", "å¾æ•æ•").Replace("HYH", "è´ºè€å¸ˆ");
finalContent = finalContent.Replace(" A ", " [è¿›åº¦é”A] ").Replace(" B ", " [è¿›åº¦é”B] ");

// è·å–æ¡Œé¢è·¯å¾„å¹¶å†™å…¥æ–‡ä»¶
var desktop = System.Environment.GetFolderPath(System.Environment.SpecialFolder.Desktop);
var exportPath = System.IO.Path.Combine(desktop, "PaperHouse_XRAY_Scan.txt");

System.IO.File.WriteAllText(exportPath, finalContent, System.Text.Encoding.UTF8);
Naninovel.Engine.Log("âœ… å…¨å­—æ®µé€è§†æå–å®Œæˆï¼è¯·æŸ¥çœ‹: " + exportPath);