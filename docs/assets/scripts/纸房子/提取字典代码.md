
---

### Naninovel å‰§æƒ…å­—å…¸æå–å·¥å…· (Managed Text)

```markdown
# æ¸¸æˆé€†å‘ç¬”è®°ï¼šNaninovel å‰§æƒ…å­—å…¸æå– (Managed Text)

> **é¡¹ç›®èƒŒæ™¯**ï¼šåœ¨ã€Šçº¸æˆ¿å­ã€‹çš„é€†å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç°æå–å‡ºçš„å‰§æœ¬æ–‡ä»¶ä¸­å¹¶æ²¡æœ‰ä¸­æ–‡æ–‡æœ¬ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ç±»ä¼¼äº `#~3fb402f3` çš„å“ˆå¸Œç´¢å¼•ã€‚
> **æŠ€æœ¯åˆ†æ**ï¼šç»è¿‡æ’æŸ¥ï¼Œå‘ç°æ¸¸æˆå¯ç”¨äº† Naninovel çš„ **Managed Textï¼ˆæ‰˜ç®¡æ–‡æœ¬ï¼‰** æœºåˆ¶ã€‚å‰§æœ¬é€»è¾‘ä¸æœ¬åœ°åŒ–æ–‡æœ¬æ˜¯åˆ†ç¦»å­˜å‚¨çš„ã€‚
> **è§£å†³æ–¹æ¡ˆ**ï¼šç¼–å†™ C# è„šæœ¬ï¼Œåˆ©ç”¨åå°„ï¼ˆReflectionï¼‰ç©¿é€ `ScriptTextMap` çš„å¤šå±‚å°è£…ï¼Œç›´æ¥ä»å†…å­˜ä¸­æå–å‡º `Hash ID` ä¸ `ä¸­æ–‡æ–‡æœ¬` çš„æ˜ å°„å…³ç³»ã€‚

## æ ¸å¿ƒåŸç†åˆ†æ

Naninovel åœ¨è¿è¡Œæ—¶ä¼šå°†æ–‡æœ¬åŠ è½½åˆ°å†…å­˜å¯¹è±¡ä¸­ï¼Œä½†å…¶ç»“æ„ç»è¿‡äº†é«˜åº¦å°è£…ã€‚é€šè¿‡ UnityExplorer çš„å¯¹è±¡åå°„åˆ†æï¼Œæˆ‘é”å®šäº†æ•°æ®çš„çœŸå®å­˜å‚¨è·¯å¾„ï¼š

1.  **Script (å‰§æœ¬å¯¹è±¡)**ï¼šåŒ…å«é€»è¾‘æŒ‡ä»¤ã€‚
2.  **TextMap (æ˜ å°„å®¹å™¨)**ï¼šå‰§æœ¬å¯¹è±¡ä¸­çš„ç§æœ‰å­—æ®µï¼Œç”¨äºç®¡ç†æ–‡æœ¬ã€‚
3.  **idToText (å…³é”®å­—æ®µ)**ï¼šåœ¨ `TextMap` å†…éƒ¨ï¼ŒçœŸæ­£çš„å­—å…¸æ•°æ®è¢«å­˜å‚¨åœ¨ä¸€ä¸ªåä¸º `idToText` çš„ `SerializableTextMap` å¯¹è±¡ä¸­ï¼ˆè¿™æ˜¯ä¹‹å‰å¸¸è§„æå–å¤±è´¥çš„åŸå› ï¼Œå¿…é¡»ç²¾å‡†å®šä½åˆ°æ­¤å­—æ®µï¼‰ã€‚
4.  **Keys / Values**ï¼šæœ€ç»ˆçš„å“ˆå¸Œé”®å’Œæ–‡æœ¬å€¼ã€‚

## C# æå–è„šæœ¬ (UnityExplorerç‰ˆ)

æ­¤è„šæœ¬ä¸“ä¸º UnityExplorer çš„ REPL Console è®¾è®¡ï¼Œèƒ½å¤Ÿè‡ªåŠ¨éå†æ‰€æœ‰å·²åŠ è½½çš„å‰§æœ¬ï¼Œå¹¶æŒ–æ˜æ·±å±‚åµŒå¥—çš„æœ¬åœ°åŒ–å­—å…¸ã€‚

```csharp
// --- [1] åˆå§‹åŒ–è¾“å‡ºæµ ---
var sb = new System.Text.StringBuilder();
sb.AppendLine("ã€Šçº¸æˆ¿å­ã€‹å­—å…¸æ–‡æœ¬æ·±åº¦æå–ç‰ˆ - " + System.DateTime.Now.ToString());
sb.AppendLine("--------------------------------------------------");

// --- [2] æŸ¥æ‰¾å†…å­˜ä¸­çš„å‰§æœ¬èµ„æº ---
// Naninovel.Script æ˜¯ Unity çš„ ScriptableObjectï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ Resources API å…¨å±€æŸ¥æ‰¾
var scripts = UnityEngine.Resources.FindObjectsOfTypeAll<Naninovel.Script>();
sb.AppendLine($"ç³»ç»Ÿä¸­å…±æ‰¾åˆ° {scripts.Length} ä¸ªå‰§æœ¬æ–‡ä»¶");

// --- [3] éå†å‰§æœ¬å¹¶æ‰§è¡Œâ€œé’»å–â€æ“ä½œ ---
foreach (var script in scripts)
{
    if (script == null) continue;

    try 
    {
        // === ç¬¬ä¸€å±‚ï¼šè·å– TextMap å®¹å™¨ ===
        // åˆ©ç”¨åå°„è·å–ç§æœ‰å­—æ®µ "TextMap" æˆ– "textMap"
        var scriptType = script.GetType();
        var mapField = scriptType.GetField("TextMap", System.Reflection.BindingFlags.Public | System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance) 
                    ?? scriptType.GetField("textMap", System.Reflection.BindingFlags.Public | System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
        
        // åŒæ—¶ä¹Ÿå°è¯•è·å–å±æ€§ (Property)ï¼Œé˜²æ­¢å­—æ®µè¢«å°è£…
        var mapProp = scriptType.GetProperty("TextMap") ?? scriptType.GetProperty("textMap");

        object textMapObj = null;
        if (mapProp != null) textMapObj = mapProp.GetValue(script);
        else if (mapField != null) textMapObj = mapField.GetValue(script);

        // å¦‚æœè·å–åˆ°äº† TextMap å®¹å™¨
        if (textMapObj != null)
        {
            // === ç¬¬äºŒå±‚ï¼šç²¾å‡†æ‰“å‡» idToText å­—æ®µ ===
            // è¿™æ˜¯ä¸€ä¸ª SerializableTextMap ç±»å‹çš„å†…éƒ¨å¯¹è±¡ï¼Œå­˜æ”¾ç€çœŸæ­£çš„å­—å…¸
            // å¿…é¡»ä½¿ç”¨ BindingFlags.NonPublic æ‰èƒ½è®¿é—®
            var targetField = textMapObj.GetType().GetField("idToText", System.Reflection.BindingFlags.Public | System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
            
            object finalDataMap = null;
            if (targetField != null)
            {
                finalDataMap = targetField.GetValue(textMapObj);
            }
            else
            {
                // å…¼å®¹æ€§å¤„ç†ï¼šå¦‚æœæ‰¾ä¸åˆ° idToTextï¼Œå°è¯•ç›´æ¥åœ¨å½“å‰å±‚çº§æŸ¥æ‰¾
                finalDataMap = textMapObj;
            }

            // === ç¬¬ä¸‰å±‚ï¼šæå– Keys å’Œ Values åˆ—è¡¨ ===
            if (finalDataMap != null)
            {
                var dataType = finalDataMap.GetType();
                // åŠ¨æ€è·å– Keys å’Œ Values å±æ€§ï¼ˆé€‚é…ä¸åŒçš„å‘½åè§„åˆ™ï¼‰
                var keysProp = dataType.GetProperty("Keys") ?? dataType.GetProperty("keys");
                var valsProp = dataType.GetProperty("Values") ?? dataType.GetProperty("values");

                if (keysProp != null && valsProp != null)
                {
                    // è½¬æ¢ä¸ºå¯æšä¸¾çš„é›†åˆ
                    var keys = keysProp.GetValue(finalDataMap) as System.Collections.Generic.ICollection<string>;
                    var vals = valsProp.GetValue(finalDataMap) as System.Collections.Generic.ICollection<string>;

                    // å¯¼å‡ºæ•°æ®
                    if (keys != null && vals != null)
                    {
                        var kList = new System.Collections.Generic.List<string>(keys);
                        var vList = new System.Collections.Generic.List<string>(vals);
                        
                        if (kList.Count > 0)
                        {
                            sb.AppendLine();
                            sb.AppendLine($"ğŸ“‚ å‰§æœ¬æº [{script.name}] - åŒ…å« {kList.Count} æ¡ç›®");
                            sb.AppendLine("--------------------------------------------------");

                            for (int i = 0; i < kList.Count; i++)
                            {
                                string k = kList[i]; // Hash ID (ä¾‹å¦‚ ~3fb402f3)
                                string v = vList[i]; // ä¸­æ–‡æ–‡æœ¬
                                
                                if (!string.IsNullOrEmpty(k))
                                {
                                    // æ ¼å¼åŒ–è¾“å‡ºï¼šHash = æ–‡æœ¬
                                    sb.AppendLine($"{k} = {v}");
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    catch (System.Exception ex)
    {
        // æ•è·åå°„è¿‡ç¨‹ä¸­çš„å¼‚å¸¸ï¼Œé˜²æ­¢å•ä¸ªæ–‡ä»¶é”™è¯¯ä¸­æ–­æ•´ä¸ªæµç¨‹
        // sb.AppendLine($"[é”™è¯¯] è§£æ {script.name} å¤±è´¥: {ex.Message}");
    }
}

// --- [4] å¯¼å‡ºç»“æœè‡³æ¡Œé¢ ---
var desktop = System.Environment.GetFolderPath(System.Environment.SpecialFolder.Desktop);
var exportPath = System.IO.Path.Combine(desktop, "PaperHouse_Dictionary_Dump.txt");

System.IO.File.WriteAllText(exportPath, sb.ToString(), System.Text.Encoding.UTF8);
Naninovel.Engine.Log("âœ… å­—å…¸æå–å®Œæˆï¼æ–‡ä»¶å·²ç”Ÿæˆ: " + exportPath);

```

## ç»“æœåº”ç”¨

è¿è¡Œä¸Šè¿°è„šæœ¬åï¼Œå°†ç”ŸæˆåŒ…å«å¦‚ä¸‹å†…å®¹çš„æ–‡ä»¶ï¼š

```text
~9be251d0 = 2017å¹´ 12æœˆ 5æ—¥
~3fb402f3 = æ€ä¹ˆä»Šå¤©æ—©ä¸Šè¿Ÿåˆ°äº†è¿™ä¹ˆä¹…ï¼Ÿ
~99926b64 = å®¶é‡Œé‚£å †ç ´äº‹å‘—ã€‚
...

```

ç»“åˆä¹‹å‰æå–çš„[å‰§æœ¬é€è§†ç»“æ„](\assets\scripts\çº¸æˆ¿å­\çº¸æˆ¿å­åŸºæœ¬é€»è¾‘æå–ä»£ç )é€šè¿‡åŒ¹é… Hash IDï¼Œå³å¯å®Œæ•´è¿˜åŸå‡ºåŒ…å«é€»è¾‘åˆ†æ”¯ä¸æ­£ç¡®å¯¹ç™½çš„å®Œæ•´å‰§æœ¬ã€‚


