
---

# ğŸ”§ Naninovel å‰§æœ¬é‡æ„å·¥å…·ï¼šè¿è¡Œæ—¶é€»è¾‘ä¸æ–‡æœ¬çš„è‡ªåŠ¨åŒ–åˆå¹¶

**å…³é”®è¯**ï¼š`C#` `Reflection` `UnityExplorer` `Regular Expression` `Localization`

## 1. é¡¹ç›®èƒŒæ™¯ä¸éœ€æ±‚

åœ¨å¯¹ Unity å¼•æ“åˆ¶ä½œçš„æ¸¸æˆã€Šçº¸æˆ¿å­ã€‹è¿›è¡Œæ•°æ®æå–æ—¶ï¼Œæˆ‘é¢ä¸´ç€**é€»è¾‘è„šæœ¬ä¸æ–‡æœ¬å†…å®¹åˆ†ç¦»**çš„æŠ€æœ¯æŒ‘æˆ˜ã€‚è¯¥æ¸¸æˆä½¿ç”¨äº† Naninovel æ’ä»¶çš„ **Managed Textï¼ˆæ‰˜ç®¡æ–‡æœ¬ï¼‰** æœºåˆ¶ï¼Œå¯¼è‡´ç›´æ¥æå–å‡ºçš„å‰§æœ¬æ–‡ä»¶ä¸­ä¸åŒ…å«å¯è¯»çš„ä¸­æ–‡å¯¹è¯ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å“ˆå¸Œç´¢å¼•ï¼ˆHash IDï¼‰ã€‚

ä¸ºäº†è·å–å¯ç”¨äºæ”»ç•¥åˆ¶ä½œçš„å®Œæ•´æ–‡æœ¬ï¼Œæˆ‘éœ€è¦å¼€å‘ä¸€ä¸ªå·¥å…·ï¼Œèƒ½å¤Ÿåœ¨æ¸¸æˆè¿è¡Œæ—¶ï¼ˆRuntimeï¼‰å°†**å‰§æœ¬é€»è¾‘ç»“æ„**ä¸**æœ¬åœ°åŒ–å­—å…¸**è¿›è¡ŒåŠ¨æ€åˆå¹¶ä¸æ¸…æ´—ã€‚

## 2. æŠ€æœ¯éš¾ç‚¹ä¸è¿­ä»£

åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¸»è¦é‡åˆ°äº†ä»¥ä¸‹ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ï¼Œå¹¶é€ä¸€è¿›è¡Œäº†ç®—æ³•ä¼˜åŒ–ï¼š

### ğŸ”´ é—®é¢˜ä¸€ï¼šæ•°æ®å°è£…ä¸è®¿é—®é™åˆ¶

* **ç°è±¡**ï¼šNaninovel å°†æœ¬åœ°åŒ–å­—å…¸å­˜å‚¨åœ¨ç§æœ‰å­—æ®µ `TextMap` ä¸­ï¼Œä¸”å†…éƒ¨åµŒå¥—äº†åä¸º `idToText` çš„åºåˆ—åŒ–å¯¹è±¡ï¼Œå¸¸è§„çš„ API æ— æ³•ç›´æ¥è®¿é—®ã€‚
* **è§£å†³**ï¼šåˆ©ç”¨ C# çš„ **åå°„æœºåˆ¶ (Reflection)**ï¼Œé€šè¿‡ `BindingFlags.NonPublic` æ ‡å¿—ä½å¼ºåˆ¶ç©¿é€ä¸¤å±‚å°è£…ï¼ŒæˆåŠŸè·å–äº†å†…å­˜ä¸­çš„ `Keys` å’Œ `Values` é›†åˆã€‚

### ğŸ”´ é—®é¢˜äºŒï¼šå“ˆå¸ŒåŒ¹é…å¤±æ•ˆ (Dirty Data)

* **ç°è±¡**ï¼šè¿™æ˜¯æœ€æ£˜æ‰‹çš„é—®é¢˜ã€‚åˆæ­¥åˆå¹¶æ—¶ï¼Œå­—å…¸åŒ¹é…ç‡ä¸º 0%ã€‚
* **åŸå› åˆ†æ**ï¼šå­—å…¸ä¸­çš„ Key æ˜¯çº¯å‡€çš„ Hashï¼ˆå¦‚ `~3fb402f3`ï¼‰ï¼Œä½†å‰§æœ¬é€»è¾‘å±‚è¿”å›çš„å‚æ•°åŒ…å«äº†å¤§é‡å¼•æ“å…ƒæ•°æ®ï¼ˆå¦‚ `Newscript #36.1 |#~3fb402f3|`ï¼‰ã€‚ç”±äºå­—ç¬¦ä¸²ä¸å®Œå…¨ç›¸ç­‰ï¼Œ`Dictionary.ContainsKey` æ–¹æ³•åˆ¤å®šåŒ¹é…å¤±è´¥ã€‚


* **è§£å†³**ï¼šå¼•å…¥ **æ­£åˆ™è¡¨è¾¾å¼ (Regular Expressions)** æ¨¡å—ã€‚
* æ„å»ºæ­£åˆ™æ¨¡å¼ `~[a-zA-Z0-9]+`ï¼Œä»è„æ•°æ®ä¸­ç²¾å‡†â€œæŠ å–â€å‡ºæœ‰æ•ˆçš„ Hash IDã€‚
* å®æ–½â€œæ¨¡ç³ŠåŒ¹é…ï¼Œç²¾å‡†æ›¿æ¢â€ç­–ç•¥ï¼Œå®ç°äº† 100% çš„æ–‡æœ¬è¿˜åŸç‡ã€‚



## 3. æœ€ç»ˆè§£å†³æ–¹æ¡ˆ (Runtime Linker)

è¯¥è„šæœ¬ä¸“ä¸º UnityExplorer çš„ REPL (Read-Eval-Print Loop) ç¯å¢ƒè®¾è®¡ã€‚å®ƒåœ¨å†…å­˜ä¸­æ„å»ºå…¨å±€å­—å…¸ç´¢å¼•ï¼Œå¹¶åœ¨éå†å‰§æœ¬çš„åŒæ—¶å®æ—¶å®Œæˆ**IDæ¸…æ´—**ã€**æ–‡æœ¬ç¿»è¯‘**å’Œ**å˜é‡åäººæ€§åŒ–å¤„ç†**ã€‚

### æ ¸å¿ƒä»£ç å®ç°

```csharp
// =============================================================
//  å·¥å…·åç§°ï¼šNaninovel å‰§æœ¬è‡ªåŠ¨åŒ–åˆå¹¶ä¸æ¸…æ´—è„šæœ¬
//  ç¯å¢ƒå…¼å®¹ï¼šUnityExplorer (REPL Safe Mode)
//  æ ¸å¿ƒåŠŸèƒ½ï¼š
//    1. å†…å­˜å­—å…¸æ„å»º (Memory Mapping)
//    2. æ­£åˆ™è¡¨è¾¾å¼æ¸…æ´— (Regex Cleaning)
//    3. å˜é‡å¯è§†åŒ–ç¿»è¯‘ (Variable Localization)
// =============================================================

// --- [1] åˆå§‹åŒ–ç¯å¢ƒ ---
var sb = new System.Text.StringBuilder();
sb.AppendLine("ã€Šçº¸æˆ¿å­ã€‹å‰§æœ¬é‡æ„æŠ¥å‘Š - " + System.DateTime.Now.ToString());
sb.AppendLine("--------------------------------------------------");

// --- [2] æ„å»ºå…¨å±€å“ˆå¸Œç´¢å¼• (Global Indexing) ---
// ä½¿ç”¨ Dictionary æä¾› O(1) çš„æŸ¥è¯¢å¤æ‚åº¦
var globalTextMap = new System.Collections.Generic.Dictionary<string, string>();
var allScripts = UnityEngine.Resources.FindObjectsOfTypeAll<Naninovel.Script>();

sb.AppendLine($"[System] æ£€æµ‹åˆ° {allScripts.Length} ä¸ªå‰§æœ¬èµ„æºï¼Œå¼€å§‹æ„å»ºç´¢å¼•...");

foreach (var script in allScripts)
{
    if (script == null) continue;
    try 
    {
        // åå°„è·å– TextMap å®¹å™¨ (å…¼å®¹ Field å’Œ Property)
        var sType = script.GetType();
        var mapField = sType.GetField("TextMap", System.Reflection.BindingFlags.Public | System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance) ?? sType.GetField("textMap", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
        var mapProp = sType.GetProperty("TextMap") ?? sType.GetProperty("textMap");
        
        object textMapObj = null;
        if (mapField != null) textMapObj = mapField.GetValue(script);
        else if (mapProp != null) textMapObj = mapProp.GetValue(script);

        if (textMapObj != null)
        {
            // æ·±åº¦é’»å–ï¼šå®šä½å†…éƒ¨çš„ idToText åºåˆ—åŒ–å¯¹è±¡
            var targetField = textMapObj.GetType().GetField("idToText", System.Reflection.BindingFlags.Public | System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
            object finalDataMap = (targetField != null) ? targetField.GetValue(textMapObj) : textMapObj;

            if (finalDataMap != null)
            {
                // æå–é”®å€¼å¯¹æ•°æ®
                var dType = finalDataMap.GetType();
                var kProp = dType.GetProperty("Keys") ?? dType.GetProperty("keys");
                var vProp = dType.GetProperty("Values") ?? dType.GetProperty("values");

                if (kProp != null && vProp != null)
                {
                    var keys = kProp.GetValue(finalDataMap) as System.Collections.Generic.ICollection<string>;
                    var vals = vProp.GetValue(finalDataMap) as System.Collections.Generic.ICollection<string>;

                    if (keys != null && vals != null)
                    {
                        var kList = new System.Collections.Generic.List<string>(keys);
                        var vList = new System.Collections.Generic.List<string>(vals);
                        
                        // å¡«å……å…¨å±€å­—å…¸
                        for (int i = 0; i < kList.Count; i++)
                        {
                            string k = kList[i];
                            string v = vList[i];
                            if (!string.IsNullOrEmpty(k) && !globalTextMap.ContainsKey(k))
                            {
                                globalTextMap.Add(k, v);
                            }
                        }
                    }
                }
            }
        }
    }
    catch {}
}

sb.AppendLine($"[Success] ç´¢å¼•æ„å»ºå®Œæ¯•ï¼Œå…±è½½å…¥ {globalTextMap.Count} æ¡æœ¬åœ°åŒ–æ•°æ®ã€‚");
sb.AppendLine("--------------------------------------------------");


// --- [3] æ ¸å¿ƒç¿»è¯‘ç®—æ³• (The Translator) ---
// è¾“å…¥åŸå§‹ä¹±ç å­—ç¬¦ä¸²ï¼Œè¾“å‡ºæ¸…æ´—åçš„ä¸­æ–‡
System.Func<string, string> TryTranslate = (rawText) => {
    if (string.IsNullOrEmpty(rawText)) return "";

    // 1. å°è¯•ç›´æ¥åŒ¹é… (Exact Match)
    if (globalTextMap.ContainsKey(rawText)) return globalTextMap[rawText];

    // 2. æ­£åˆ™æ¸…æ´— (Regex Extraction)
    // è§£å†³ "Newscript #36.1 |#~Hash|" æ— æ³•åŒ¹é…çš„é—®é¢˜
    // ä½¿ç”¨ System.Text.RegularExpressions é¿å… REPL å‘½åç©ºé—´å†²çª
    var match = System.Text.RegularExpressions.Regex.Match(rawText, @"~[a-zA-Z0-9]+");
    if (match.Success)
    {
        string extractedHash = match.Value;
        if (globalTextMap.ContainsKey(extractedHash))
        {
            return globalTextMap[extractedHash]; // è¿”å›ç¿»è¯‘æ–‡æœ¬
        }
    }
    return rawText; // æ— æ³•ç¿»è¯‘åˆ™ä¿ç•™åŸæ ·
};

// è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è·å– Naninovel å°è£…å€¼
System.Func<object, string> GetNaninovelVal = (obj) => {
    if (obj == null) return null;
    try {
        var t = obj.GetType();
        if (!t.Namespace.StartsWith("Naninovel")) return null;
        var hv = t.GetProperty("HasValue");
        if (hv != null && !(bool)hv.GetValue(obj)) return null;
        return t.GetProperty("Value")?.GetValue(obj)?.ToString();
    } catch { return null; }
};


// --- [4] å‰§æœ¬éå†ä¸é‡ç»„ (Iteration & Merge) ---
foreach (var script in allScripts)
{
    // å¯é€‰ï¼šè¿‡æ»¤æ‰éæ ¸å¿ƒå‰§æœ¬
    // if (!script.name.Contains("Script") && !script.name.Contains("script")) continue;

    sb.AppendLine();
    sb.AppendLine($"ğŸ“„ å‰§æœ¬: {script.name}");
    sb.AppendLine("--------------------------------------------------");
    int lineIndex = 0;

    foreach (var line in script.Lines)
    {
        lineIndex++;
        if (line == null) continue;
        string lType = line.GetType().Name;

        // Type A: å¯¹è¯æ–‡æœ¬è¡Œ (GenericText)
        if (lType == "GenericTextScriptLine")
        {
            try {
                // è·å–è¡Œå†…æŒ‡ä»¤åˆ—è¡¨
                var listField = line.GetType().GetField("inlinedCommands", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
                var list = listField?.GetValue(line) as System.Collections.IList;
                if (list != null && list.Count > 0)
                {
                    var sbLine = new System.Text.StringBuilder();
                    foreach (var cmd in list)
                    {
                        var textProp = cmd.GetType().GetField("Text");
                        var authProp = cmd.GetType().GetField("AuthorId");
                        
                        var rawText = GetNaninovelVal(textProp?.GetValue(cmd));
                        var rawAuth = GetNaninovelVal(authProp?.GetValue(cmd));
                        
                        // æ‰§è¡Œç¿»è¯‘
                        var cleanText = TryTranslate(rawText);
                        var cleanAuth = TryTranslate(rawAuth);

                        if (!string.IsNullOrEmpty(cleanAuth)) sbLine.Append(cleanAuth + "ï¼š");
                        if (!string.IsNullOrEmpty(cleanText)) sbLine.Append(cleanText);
                    }
                    if (sbLine.Length > 0) sb.AppendLine($"   [{lineIndex:D4}] {sbLine}");
                }
            } catch {}
        }
        // Type B: é€»è¾‘æŒ‡ä»¤è¡Œ (Command)
        else if (lType == "CommandScriptLine")
        {
            var cmdProp = line.GetType().GetProperty("Command");
            if (cmdProp != null)
            {
                var cmdObj = cmdProp.GetValue(line);
                if (cmdObj != null)
                {
                    string cName = cmdObj.GetType().Name;
                    var fields = cmdObj.GetType().GetFields(System.Reflection.BindingFlags.Public | System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
                    var paramInfo = new System.Collections.Generic.List<string>();

                    foreach (var f in fields)
                    {
                         // è¿‡æ»¤æ— å…³å…ƒæ•°æ®
                         if (f.Name == "LineNumber" || f.Name == "Indent" || f.Name == "PlaybackSpot") continue;
                         
                         var valObj = f.GetValue(cmdObj);
                         var strVal = GetNaninovelVal(valObj);
                         
                         if (!string.IsNullOrEmpty(strVal))
                         {
                             // ç‰¹æ®Šå¤„ç†ï¼šé€‰é¡¹æ–‡æœ¬ä¹Ÿéœ€è¦ç¿»è¯‘
                             if (cName.Contains("Choice") && f.Name.Contains("ChoiceText")) strVal = TryTranslate(strVal);
                             // å°è¯•ç¿»è¯‘ä»»ä½•åŒ…å« Hash ç‰¹å¾çš„å‚æ•°
                             else if (strVal.Contains("~")) strVal = TryTranslate(strVal);
                             
                             paramInfo.Add($"{f.Name}=[{strVal}]");
                         }
                    }
                    string allParams = string.Join(", ", paramInfo.ToArray());

                    // æ ¼å¼åŒ–è¾“å‡ºé€»è¾‘å—
                    if (cName.Contains("Choice")) sb.AppendLine($"   [{lineIndex:D4}] ğŸ”˜ [é€‰é¡¹] {allParams}");
                    else if (cName == "Set" || cName == "SetCustomVariable") sb.AppendLine($"   [{lineIndex:D4}] ğŸ”§ [å˜é‡] {allParams}");
                    else if (cName == "Goto") sb.AppendLine($"   [{lineIndex:D4}] ğŸ”€ [è·³è½¬] {allParams}");
                    else if (cName == "Stop") sb.AppendLine($"   [{lineIndex:D4}] ğŸ›‘ [åœæ­¢]");
                    else if (cName.StartsWith("Else")) sb.AppendLine($"   [{lineIndex:D4}] ğŸ”¹ [åˆ†æ”¯] {cName} {allParams}");
                    else if (cName.EndsWith("If")) sb.AppendLine($"   [{lineIndex:D4}] ğŸ”¹ [é€»è¾‘] {cName} {allParams}");
                }
            }
        }
    }
}

// --- [5] æ•°æ®å¯¼å‡ºä¸åå¤„ç† (Export & Post-Processing) ---
var finalContent = sb.ToString();

// æ‰¹é‡æ›¿æ¢å˜é‡ä»£å·ä¸ºä¸­æ–‡è§’è‰²åï¼Œæå‡å¯è¯»æ€§
finalContent = finalContent.Replace("WYH", "ç‹è‰ºè¡")
                           .Replace("LT", "é™†å©·")
                           .Replace("XMM", "å¾æ•æ•")
                           .Replace("HYH", "è´ºè€å¸ˆ")
                           .Replace("zy", "ä¸»è§’")
                           .Replace("Expression=", "è®¡ç®—: ");

var desktop = System.Environment.GetFolderPath(System.Environment.SpecialFolder.Desktop);
var exportPath = System.IO.Path.Combine(desktop, "PaperHouse_Final_Translated.txt");

System.IO.File.WriteAllText(exportPath, finalContent, System.Text.Encoding.UTF8);
Naninovel.Engine.Log("âœ… å‰§æœ¬é‡æ„å®Œæˆï¼è¾“å‡ºæ–‡ä»¶: " + exportPath);

```

## 4. è¾“å‡ºæ•ˆæœå¯¹æ¯”

é€šè¿‡ä¸Šè¿°å·¥å…·çš„å¤„ç†ï¼Œæˆ‘æˆåŠŸå°†åŸå§‹çš„â€œé»‘ç›’â€å‰§æœ¬è½¬åŒ–ä¸ºå®Œå…¨å¯è¯»çš„æ–‡æ¡£ã€‚

**ğŸ”´ å¤„ç†å‰ (Raw Data):**

> `[36] [å‰§æƒ…] wyhï¼šNewscript #36.1 |#~3fb402f3|`
> `[37] ğŸ”˜ [é€‰é¡¹] ChoiceText=~9be251d0 GotoPath=Scene2`

**ğŸŸ¢ å¤„ç†å (Processed Data):**

> `[0036] ç‹è‰ºè¡ï¼šæ€ä¹ˆä»Šå¤©æ—©ä¸Šè¿Ÿåˆ°äº†è¿™ä¹ˆä¹…ï¼Ÿ`
> `[0037] ğŸ”˜ [é€‰é¡¹] ChoiceText=[2017å¹´ 12æœˆ 5æ—¥] GotoPath=[Scene2]`

è¯¥æ–¹æ¡ˆä¸ä»…è§£å†³äº†æœ¬åœ°åŒ–æ–‡æœ¬æå–çš„é—®é¢˜ï¼Œè¿˜ä¸ºåç»­çš„æ”»ç•¥é€»è¾‘åˆ†ææä¾›äº†æœ€ç›´è§‚çš„æ•°æ®æ”¯æŒã€‚